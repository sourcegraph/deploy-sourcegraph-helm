---
meta:
  productName: "deploy-sourcegraph-helm"
  owners:
    - "@sourcegraph/release"
  repository: "github.com/sourcegraph/deploy-sourcegraph-helm"
inputs:
  releaseId: server
requirements:
  - name: "comby exists"
    cmd: "which comby"
    fixInstructions: "install comby"
  - name: "GitHub cli exists"
    cmd: "which gh"
    fixInstructions: "install GitHub cli"
  - name: "sg-rfc exists"
    cmd: "which sg-rfc"
    fixInstructions: "install sg"
  # - name: "DOCKER_USERNAME exported"
  #   env: "DOCKER_USERNAME"
  # - name: "DOCKER_PASSWORD exported"
  #   env: "DOCKER_PASSWORD"
internal:
  create:
    steps:
      patch:
          - name: sg ops update-images
            cmd: |
              registry=us-central1-docker.pkg.dev/sourcegraph-ci/rfc795-internal
              echo "updating sourcegraph images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" --skip codeintel-db,codeinsights-db,alpine-3.14,postgres-12-alpine charts/sourcegraph/

              echo "updating sourcegraph-executor (dind) images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" charts/sourcegraph-executor/dind/
              echo "updating sourcegraph-executor (k8s) images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" charts/sourcegraph-executor/k8s/

              echo "updating sourcegraph-migrator images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" charts/sourcegraph-migrator/
          - name: "update Chart version in Chart.yaml"
            cmd: |
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph/Chart.yaml
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph-executor/dind/Chart.yaml
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph-executor/k8s/Chart.yaml
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph-migrator/Chart.yaml
          - name: "update appVersion version in Chart.yaml"
            cmd: |
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph/Chart.yaml
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph-executor/dind/Chart.yaml
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph-executor/k8s/Chart.yaml
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph-migrator/Chart.yaml
          - name: "helm:docs"
            cmd: ./scripts/helm-docs.sh
          - name: "git:branch"
            cmd: |
              branch="wip_{{version}}"
              git switch -c "${branch}"
              git commit -am 'release_patch: {{version}}' -m '{{config}}'
              git push origin ${branch}
          - name: "gh"
            cmd: |
              gh pr create -f -t "PRETEND RELEASE WIP: release_patch: build {{version}}"
      minor:
          - name: sg ops update-images
            cmd: |
              registry=us-central1-docker.pkg.dev/sourcegraph-ci/rfc795-internal
              echo "updating sourcegraph images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" --skip codeintel-db,codeinsights-db,alpine-3.14,postgres-12-alpine charts/sourcegraph/

              echo "updating sourcegraph-executor (dind) images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" charts/sourcegraph-executor/dind/
              echo "updating sourcegraph-executor (k8s) images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" charts/sourcegraph-executor/k8s/

              echo "updating sourcegraph-migrator images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" charts/sourcegraph-migrator/
          - name: "update Chart version in Chart.yaml"
            cmd: |
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph/Chart.yaml
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph-executor/dind/Chart.yaml
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph-executor/k8s/Chart.yaml
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph-migrator/Chart.yaml
          - name: "update appVersion version in Chart.yaml"
            cmd: |
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph/Chart.yaml
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph-executor/dind/Chart.yaml
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph-executor/k8s/Chart.yaml
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph-migrator/Chart.yaml
          - name: "helm:docs"
            cmd: ./scripts/helm-docs.sh
          - name: "git:branch"
            cmd: |
              branch="wip_{{version}}"
              git switch -c "${branch}"
              git commit -am 'release_minor: {{version}}' -m '{{config}}'
              git push origin ${branch}
          - name: "gh"
            cmd: |
              gh pr create -f -t "PRETEND RELEASE WIP: release_minor: build {{version}}"
      major:
          - name: sg ops update-images
            cmd: |
              registry=us-central1-docker.pkg.dev/sourcegraph-ci/rfc795-internal
              echo "updating sourcegraph images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" --skip codeintel-db,codeinsights-db,alpine-3.14,postgres-12-alpine charts/sourcegraph/

              echo "updating sourcegraph-executor (dind) images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" charts/sourcegraph-executor/dind/
              echo "updating sourcegraph-executor (k8s) images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" charts/sourcegraph-executor/k8s/

              echo "updating sourcegraph-migrator images"
              sg-rfc ops update-images -t {{tag}} -k helm --registry "${registry}" charts/sourcegraph-migrator/
          - name: "chart:version"
            cmd: |
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph/Chart.yaml
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph-executor/dind/Chart.yaml
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph-executor/k8s/Chart.yaml
              comby -matcher ".generic" -in-place "version: \":[~\d+\.\d+\.\d+]\"" 'version: "{{tag}}"' -f charts/sourcegraph-migrator/Chart.yaml
          - name: "chart:appVersion"
            cmd: |
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph/Chart.yaml
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph-executor/dind/Chart.yaml
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph-executor/k8s/Chart.yaml
              comby -matcher ".generic" -in-place "appVersion: \":[~\d+\.\d+\.\d+]\"" 'appVersion: "{{inputs.server.tag}}"' -f charts/sourcegraph-migrator/Chart.yaml
          - name: "helm:docs"
            cmd: ./scripts/helm-docs.sh
          - name: "git:branch"
            cmd: |
              branch="wip_{{version}}"
              git switch -c "${branch}"
              git commit -am 'release_major: {{version}}' -m '{{config}}'
              git push origin ${branch}
          - name: "gh"
            cmd: |
              gh pr create -f -t "PRETEND RELEASE WIP: release_major: build {{version}}"
  finalize:
    steps:
      - name: "git:finalize"
        cmd: |
          set -e
          branch="wip-release-{{version}}"
          git switch -c "${branch}"
          echo "pushing branch ${branch}"
          git push origin "${branch}"
          git checkout -

test:
  steps:
    - name: "foo"
      cmd: |
        echo "Test"

promoteToPublic:
  create:
    steps:
      - name: sg ops update-images with tag
        cmd: |
          set -e
          registry=us-central1-docker.pkg.dev/sourcegraph-ci/rfc795-public
          echo "updating sourcegraph images"
          sg-rfc ops update-images \
          -t {{tag}} \
          -k helm \
          --registry "${registry}" \
          --skip codeintel-db,codeinsights-db,alpine-3.14,postgres-12-alpine \
          --docker-username $DOCKER_USERNAME \
          --docker-password $DOCKER_PASSWORD \
          charts/sourcegraph/

          echo "updating sourcegraph-executor (dind) images"
          sg-rfc ops update-images \
          -t {{tag}} \
          -k helm \
          --registry "${registry}" \
          --docker-username $DOCKER_USERNAME \
          --docker-password $DOCKER_PASSWORD \
          charts/sourcegraph-executor/dind/

          echo "updating sourcegraph-executor (k8s) images"
          sg-rfc ops update-images \
          -t {{tag}} \
          -k helm \
          --registry "${registry}" \
          --docker-username $DOCKER_USERNAME \
          --docker-password $DOCKER_PASSWORD \
          charts/sourcegraph-executor/k8s/

          echo "updating sourcegraph-migrator images"
          sg-rfc ops update-images \
          -t {{tag}} \
          -k helm \
          --registry "${registry}" \
          --docker-username $DOCKER_USERNAME \
          --docker-password $DOCKER_PASSWORD \
          charts/sourcegraph-migrator/
      - name: "update helm docs"
        cmd: ./scripts/helm-docs.sh
      - name: "git:branch"
        cmd: |
          branch="promote-release_{{version}}"
          git switch -c "${branch}"
          git commit -am "promote_release: {{version}}" -m '{{config}}'
          git push origin "${branch}"
      - name: "gh cli"
        cmd: |
          set -x
          branch="wip-release-{{version}}"
          # we need to fetch from origin just in case this branch doesn't exist locally, so that the PR can find the base
          git fetch origin "${branch}"
          gh pr create -f -t "PRETEND PROMOTE RELEASE - release: build {{version}}" --base "${branch}"
  finalize:
    steps:
      - name: git:tag
        cmd: |
          set -e
          branch="wip-release-{{version}}"
          git checkout "${branch}"
          git tag wip-{{version}}
          git push origin ${branch} --tags
